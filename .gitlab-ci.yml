stages:
  - test
  - build
  - deploy

# Run flake8 to check for code quality
lint-patients-api-job:
  image: python:3-bullseye
  stage: test
  script:
    - pip install flake8
    - flake8 api

lint-accounts-api-job:
  image: python:3-bullseye
  stage: test
  script:
    - pip install flake8
    - flake8 accounts_api

run-patients-api-tests-job:
  image: python:3.10-bullseye
  stage: test
  script:
    - cd api/
    - python -m pip install --upgrade pip
    - python -m pip install -r requirements.txt
    - python -m pytest
  variables:
    DATABASE_URL: postgresql://gamma:password@postgres/gamma

# Build the React/JavaScript front-end
build-front-end-job:
  stage: build
  image: node:lts-bullseye
  needs:
    - run-patients-api-tests-job
    - lint-patients-api-job
    - lint-accounts-api-job
  variables:
    # If either of these variables is defined in the GitLab
    # CI/CD variables, that value will override the value here.
    # You need to substitute in your real values for
    # GROUP_NAME, PROJECT_NAME, & WEBSERVICE_NAME below.
    PUBLIC_URL: https://heaven-seven.gitlab.io/module3-project-gamma/
    REACT_APP_ACCOUNTS_API_HOST: https://accounts-api-uwsq.onrender.com
    REACT_APP_PATIENTS_API_HOST: https://patient-portal-api.onrender.com
  script:
    - cd ghi
    - npm install
    - cp build/index.html build/404.html
  artifacts:
    paths:
      - ghi/build/

# Deploy the React/JavaScript front-end to GitLab pages
deploy-patients-api:
  stage: deploy
  rules:
    # uncomment line below after changes are merged into main
    # to force deployments to only happen from main branch
    #- if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  dependencies:
    - run-patients-api-tests-job
    - lint-patients-api-job
  needs:
    - run-patients-api-tests-job
    - lint-patients-api-job
  script:
    - curl --request POST --header 'Content-Type: application/json' "https://api.render.com/deploy/srv-ce4p3hpgp3jkq2r2rj50?key=vHKBJ02zCy4"
